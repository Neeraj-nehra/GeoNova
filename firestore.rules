rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile data.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their own profile.
     * @allow (get) User with ID 'user123' can read their own profile.
     * @allow (update) User with ID 'user123' can update their own profile.
     * @allow (delete) User with ID 'user123' can delete their own profile.
     * @deny (create) User with ID 'user123' cannot create a profile with ID 'user456'.
     * @deny (get) User with ID 'user123' cannot read the profile of user 'user456'.
     * @deny (update) User with ID 'user123' cannot update the profile of user 'user456'.
     * @deny (delete) User with ID 'user123' cannot delete the profile of user 'user456'.
     * @principle Enforces user-ownership; only the user can access their own profile.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource.data != null;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false; // Listing user documents is not permitted.
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Manages admin roles; document existence grants admin privileges.
     * @path /roles_admin/{userId}
     * @allow (create) User with ID 'admin123' can be granted admin role (document created).
     * @allow (get) Anyone can check if 'admin123' has admin role (document exists).
     * @allow (update) User with ID 'admin123' with admin rights can update their admin role (document updated).
     * @allow (delete) User with ID 'admin123' with admin rights can have their admin role revoked (document deleted).
     * @deny (create) User with ID 'user123' cannot grant themselves admin role.
     * @principle Implements role-based access control using document existence.
     */
    match /roles_admin/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isAdmin() {
        return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
      }

      allow get: if isSignedIn();
      allow list: if false; // Listing admin roles is not permitted.
      allow create: if isSignedIn() && request.auth.uid == userId && !exists(/databases/$(database)/documents/roles_admin/$(userId));
      allow update: if isAdmin() && request.auth.uid == userId;
      allow delete: if isAdmin() && request.auth.uid == userId;
    }

    /**
     * @description Controls access to landslide observation points.
     * @path /landslidePoints/{landslidePointId}
     * @allow (get) Anyone can read landslide point data.
     * @allow (list) Anyone can list landslide points.
     * @allow (create) Any signed in user can create a new landslide point.
     * @deny (update) Only the admin can update the landslide points.
     * @deny (delete) Only the admin can delete the landslide points.
     * @principle Publicly readable, owner-writeable with admin override.
     */
    match /landslidePoints/{landslidePointId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isAdmin() {
        return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
      }

      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && isAdmin();
      allow delete: if isSignedIn() && isAdmin();
    }

    /**
     * @description Controls access to geographical zones monitored for landslide risk.
     * @path /zones/{zoneId}
     * @allow (get) Only the admin can read geographical zones.
     * @allow (list) Only the admin can list the geographical zones.
     * @allow (create) Only the admin can create a new geographical zone.
     * @allow (update) Only the admin can update an existing geographical zone.
     * @allow (delete) Only the admin can delete an existing geographical zone.
     * @principle Restricts zone management to administrators.
     */
    match /zones/{zoneId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isAdmin() {
        return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
      }

      function isExistingAdmin() {
        return isAdmin() && resource.data != null;
      }

      allow get: if isSignedIn() && isAdmin();
      allow list: if isSignedIn() && isAdmin();
      allow create: if isSignedIn() && isAdmin();
      allow update: if isSignedIn() && isAdmin();
      allow delete: if isSignedIn() && isAdmin();
    }

    /**
     * @description Controls access to alerts associated with specific zones.
     * @path /zones/{zoneId}/alerts/{alertId}
     * @allow (get) Only the admin can read alerts for a specific zone.
     * @allow (list) Only the admin can list alerts for a specific zone.
     * @allow (create) Only the admin can create alerts for a specific zone.
     * @allow (update) Only the admin can update alerts for a specific zone.
     * @allow (delete) Only the admin can delete alerts for a specific zone.
     * @principle Alerts are managed by administrators within their respective zones.
     */
    match /zones/{zoneId}/alerts/{alertId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isAdmin() {
        return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
      }

      function isExistingAdmin() {
        return isAdmin() && resource.data != null;
      }

      allow get: if isSignedIn() && isAdmin();
      allow list: if isSignedIn() && isAdmin();
      allow create: if isSignedIn() && isAdmin();
      allow update: if isSignedIn() && isAdmin();
      allow delete: if isSignedIn() && isAdmin();
    }

    /**
     * @description Allows public read access to environmental data records.
     * @path /environmentalData/{environmentalDataId}
     * @allow (get) Anyone can read environmental data.
     * @allow (list) Anyone can list environmental data.
     * @deny (create) No one can create environmental data.
     * @deny (update) No one can update environmental data.
     * @deny (delete) No one can delete environmental data.
     * @principle Environmental data is publicly readable.
     */
    match /environmentalData/{environmentalDataId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}